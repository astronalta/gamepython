#!/usr/bin/ruby

require 'optparse'

failed = false
options = {}

OptionParser.new do |opts|
    opts.on('-f', '--full', 'Run all tests, including memchecker') do |v|
        options[:full] = v
    end
    opts.on('-v', '--verbose', 'Print test status') do |v|
        options[:verbose] = v
    end
end.parse!

Dir.chdir('tests')

tests = Dir.glob('*.ap')
tests.each do |test|
    if options[:verbose]
        puts test
    end

    test.sub!(/.ap$/, "")

    if options[:full]
        flags = ""
        flags = flags + " --leak-check=full"
        flags = flags + " --suppressions=../scripts/valgrind.supp"
        flags = flags + " --gen-suppressions=all"
        result = `valgrind #{flags} -q ../bin/test #{test} 2>&1 | diff - #{test}.ap.out`
    else
        result = `../bin/test #{test} 2>&1 | diff - #{test}.ap.out`
    end
    if !result.empty? || $? != 0
        (1..79).each { putc '-' }        
        puts
        puts "FAILED TEST: #{test}"
        (1..79).each { putc '-' }        
        puts
        puts result
        failed = true
    end
end

tests = Dir.glob('*.rb')
tests.each do |test|
    if options[:verbose]
        puts test
    end
    
    result = `ruby #{test} 2>&1 | diff - #{test}.out`
    if !result.empty? || $? != 0
        (1..79).each { putc '-' }
        puts
        puts "FAILED TEST: #{test}"
        (1..79).each { putc '-' }
        puts
        puts result
        failed = true
    end
end


if failed 
    exit(-1)
elsif options[:verbose]
    puts "All #{tests.length} tests passed."
end



